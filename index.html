<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHORDS FLOW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Harmony (Stone, Amber, Teal accents) -->
    <!-- Application Structure Plan: A tab-based SPA with three main sections: 'Key Explorer' for dynamic chord discovery, 'Game Music Harmony' for application-based exploration of moods, and 'Theory Deep Dive' for advanced concepts. This structure separates the core interactive tool from the application examples and reference material, allowing users to choose their learning path. The Key Explorer is the central feature, promoting hands-on learning over passive reading. -->
    <!-- Visualization & Content Choices: Report Info: Diatonic chords per key. Goal: Inform/Organize. Viz: Dynamic HTML grid showing chord name, Roman numeral, and quality. Interaction: Dropdown selectors for root note and key type update the grid. Justification: A direct, interactive way to learn key structures. | Report Info: Common progressions & their feel. Goal: Compare. Viz: Interactive cards for each progression. Interaction: Clicking a card could highlight it or show examples. Justification: Organizes progressions by function and feel. | Report Info: Game music scenarios. Goal: Apply/Relate. Viz: Thematic cards for each scenario (Battle, Explore, etc.). Interaction: Click to see suggested progressions. Justification: Connects theory directly to practical, creative application. | Library/Method: All interactions handled by Vanilla JS. Layout by Tailwind CSS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #fdfbf7;
            color: #44403c;
        }
        .tab-btn {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
        .chord-card {
            /* No longer interactive for drawing, so remove hover effects */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        /* .chord-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        } */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%230d9488%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 0.65rem auto;
            padding-right: 2rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto max-w-7xl px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-stone-800">Tr√¨nh Kh√°m Ph√° V√≤ng H√≤a Thanh</h1>
            <p class="mt-2 text-lg text-stone-600">C√¥ng c·ª• t∆∞∆°ng t√°c ƒë·ªÉ h·ªçc v√† ·ª©ng d·ª•ng l√Ω thuy·∫øt √¢m nh·∫°c</p>
        </header>

        <nav class="mb-8 border-b border-stone-200">
            <ul class="flex flex-wrap -mb-px justify-center text-md font-medium text-center text-stone-500">
                <li class="mr-2">
                    <button class="tab-btn active inline-block p-4" data-tab="explorer">üéπ Kh√°m Ph√° Gi·ªçng</button>
                </li>
                <li class="mr-2">
                    <button class="tab-btn inline-block p-4" data-tab="game-music">üéÆ H√≤a Thanh Game</button>
                </li>
                <li>
                    <button class="tab-btn inline-block p-4" data-tab="theory">üìö L√Ω Thuy·∫øt N√¢ng Cao</button>
                </li>
            </ul>
        </nav>

        <main>
            <!-- Key Explorer Section -->
            <section id="explorer" class="section active">
                <div class="text-center mb-8">
                    <p class="text-stone-700">Ch·ªçn m·ªôt gi·ªçng ƒëi·ªáu ƒë·ªÉ kh√°m ph√° c√°c h·ª£p √¢m diatonic v√† nh·ªØng v√≤ng h√≤a thanh ph·ªï bi·∫øn. ƒê√¢y l√† b∆∞·ªõc ƒë·∫ßu ti√™n ƒë·ªÉ hi·ªÉu c·∫•u tr√∫c v√† c·∫£m x√∫c c·ªßa m·ªôt tone nh·∫°c.</p>
                </div>
                <div class="flex justify-center items-center gap-4 mb-10 bg-white p-6 rounded-xl shadow-md max-w-md mx-auto">
                    <div class="w-1/2">
                        <label for="key-selector" class="block mb-2 text-sm font-medium text-stone-900">N·ªët Ch·ªß:</label>
                        <select id="key-selector" class="bg-stone-50 border border-stone-300 text-stone-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5">
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label for="mode-selector" class="block mb-2 text-sm font-medium text-stone-900">Ch·∫ø ƒê·ªô:</label>
                        <select id="mode-selector" class="bg-stone-50 border border-stone-300 text-stone-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5">
                            <option value="major">Tr∆∞·ªüng (Major)</option>
                            <option value="minor">Th·ª© (minor)</option>
                        </select>
                    </div>
                </div>

                <div id="key-details" class="space-y-10">
                    <div>
                        <h3 class="text-2xl font-bold mb-4 text-center text-teal-700">H·ª£p √Çm Diatonic</h3>
                        <div id="diatonic-chords" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4"></div>
                        <div class="mt-10 text-center">
                            <label class="mr-4 font-medium">Hi·ªÉn th·ªã h·ª£p √¢m b·∫±ng:</label>
                            <label class="mr-4">
                                <input type="radio" name="chord-view" value="guitar" checked> Guitar
                            </label>
                            <label>
                                <input type="radio" name="chord-view" value="piano"> Piano
                            </label>
                        </div>
                        <div id="chord-diagrams-container" class="mt-8 grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-x-4 gap-y-6 items-start"></div>

                    </div>
                    <div>
                        <h3 class="text-2xl font-bold mb-4 text-center text-teal-700">V√≤ng H√≤a Thanh Ph·ªï Bi·∫øn</h3>
                        <div id="progressions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<div class="mt-10">
    <h4 class="font-bold text-lg text-teal-600">H·ª£p √Çm Vay M∆∞·ª£n (Borrowed Chords)</h4>
    <ul class="list-disc list-inside mt-2 space-y-1">
        <li><b>iv</b> ‚Üí chuy·ªÉn nh·∫π sang m√†u bu·ªìn (v√≠ d·ª•: Fm trong C major)</li>
        <li><b>bVII</b> ‚Üí t·∫°o √¢m h∆∞·ªüng pop/rock c·ªï ƒëi·ªÉn (v√≠ d·ª•: Bb trong C major)</li>
        <li><b>bVI</b> ‚Üí c·∫£m x√∫c b·∫•t ng·ªù, ƒëi·ªán ·∫£nh (v√≠ d·ª•: Ab trong C major)</li>
    </ul>
</div>
<div class="mt-10">
    <h4 class="font-bold text-lg text-teal-600">Chuy·ªÉn Gi·ªçng (Modulation) V·ªõi H·ª£p √Çm Chung</h4>
    <p>ƒê·ªÉ chuy·ªÉn t·ª´ gi·ªçng n√†y sang gi·ªçng kh√°c m·ªôt c√°ch m∆∞·ª£t m√†, ta th∆∞·ªùng d√πng h·ª£p √¢m chung ("pivot chord").</p>
    <ul class="list-disc list-inside mt-2 space-y-1">
        <li>V√≠ d·ª•: G ‚Äì Am ‚Äì Bm ‚Äì <b>F#7 ‚Äì B7 ‚Äì Em</b> ‚Üí chuy·ªÉn m∆∞·ª£t t·ª´ G major sang E minor.</li>
        <li>Ho·∫∑c: C ‚Äì F ‚Äì G ‚Äì <b>G7 ‚Äì C</b> ‚Üí sau ƒë√≥ chuy·ªÉn sang A minor b·∫±ng E7 ‚Äì Am.</li>
    </ul>
</div>
</div>
                    </div>
                </div>
            </section>

            <!-- Game Music Section -->
            <section id="game-music" class="section">
                <div class="text-center mb-8 max-w-3xl mx-auto">
                    <p class="text-stone-700">√Çm nh·∫°c l√† linh h·ªìn c·ªßa game. M·ªói v√≤ng h√≤a thanh c√≥ th·ªÉ t·∫°o ra m·ªôt kh√¥ng kh√≠ ho√†n to√†n kh√°c bi·ªát. Kh√°m ph√° c√°ch s·ª≠ d·ª•ng ch√∫ng ƒë·ªÉ x√¢y d·ª±ng th·∫ø gi·ªõi c·∫£m x√∫c cho ng∆∞·ªùi ch∆°i, t·ª´ nh·ªØng ng√¥i l√†ng b√¨nh y√™n ƒë·∫øn nh·ªØng tr·∫≠n chi·∫øn k·ªãch t√≠nh.</p>
                </div>
                <div id="game-scenarios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- Theory Section -->
            <section id="theory" class="section">
                <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-teal-700 mb-6 text-center">L√Ω Thuy·∫øt N√¢ng Cao: H·ª£p √Çm √Åt Th·ª© C·∫•p (Secondary Dominants)</h2>
                    <div class="space-y-6 text-stone-800 prose prose-lg max-w-none">
                        <p>H·ª£p √¢m √°t th·ª© c·∫•p (secondary dominants) l√† c√°c h·ª£p √¢m tr∆∞·ªüng 7 (dominant 7th) kh√¥ng thu·ªôc gi·ªçng ch√≠nh, ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o s·ª± cƒÉng th·∫≥ng v√† d·∫´n d·∫Øt m·∫°nh m·∫Ω ƒë·∫øn m·ªôt h·ª£p √¢m diatonic kh√°c (ngo·∫°i tr·ª´ I v√† vii¬∞). Ch√∫ng ƒë∆∞·ª£c xem l√† "gia v·ªã" gi√∫p v√≤ng h√≤a thanh tr·ªü n√™n m√†u s·∫Øc v√† th√∫ v·ªã h∆°n.</p>
                        <p>Ch√∫ng th∆∞·ªùng ƒë∆∞·ª£c k√Ω hi·ªáu l√† "V c·ªßa X" (V/X), nghƒ©a l√† h·ª£p √¢m √°t c·ªßa h·ª£p √¢m X. Vi·ªác s·ª≠ d·ª•ng ch√∫ng s·∫Ω t·∫°o ra m·ªôt c√∫ h√≠ch b·∫•t ng·ªù nh∆∞ng h·ª£p l√Ω, l√†m tƒÉng s·ª± mong ƒë·ª£i c·ªßa ng∆∞·ªùi nghe tr∆∞·ªõc khi quay v·ªÅ h·ª£p √¢m diatonic m·ª•c ti√™u.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div class="p-4 bg-stone-50 rounded-lg border border-stone-200">
                                <h4 class="font-bold text-lg text-teal-600">Trong Gi·ªçng Tr∆∞·ªüng</h4>
                                <ul id="secondary-dominants-major" class="list-disc list-inside mt-2 space-y-1"></ul>
                            </div>
                            <div class="p-4 bg-stone-50 rounded-lg border border-stone-200">
                                <h4 class="font-bold text-lg text-teal-600">Trong Gi·ªçng Th·ª©</h4>
                                <ul id="secondary-dominants-minor" class="list-disc list-inside mt-2 space-y-1"></ul>
                            </div>
                        </div>

                        <div class="mt-6 p-4 bg-teal-50 border-l-4 border-teal-500 rounded-r-lg">
                            <p class="font-semibold">M·∫πo ·ª©ng d·ª•ng:</p>
                            <p>H√£y th·ª≠ ch√®n m·ªôt h·ª£p √¢m √°t th·ª© c·∫•p ngay tr∆∞·ªõc h·ª£p √¢m m·ª•c ti√™u. V√≠ d·ª•, trong gi·ªçng C Tr∆∞·ªüng, thay v√¨ ch∆°i v√≤ng `C ‚Äì Am ‚Äì Dm ‚Äì G`, h√£y th·ª≠ `C ‚Äì E7 ‚Äì Am ‚Äì A7 ‚Äì Dm ‚Äì G`. B·∫°n s·∫Ω nghe th·∫•y s·ª± chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† v√† gi√†u c·∫£m x√∫c h∆°n h·∫≥n.</p>
                        
<div class="mt-10">
    <h4 class="font-bold text-lg text-teal-600">H·ª£p √Çm Vay M∆∞·ª£n (Borrowed Chords)</h4>
    <ul class="list-disc list-inside mt-2 space-y-1">
        <li><b>iv</b> ‚Üí chuy·ªÉn nh·∫π sang m√†u bu·ªìn (v√≠ d·ª•: Fm trong C major)</li>
        <li><b>bVII</b> ‚Üí t·∫°o √¢m h∆∞·ªüng pop/rock c·ªï ƒëi·ªÉn (v√≠ d·ª•: Bb trong C major)</li>
        <li><b>bVI</b> ‚Üí c·∫£m x√∫c b·∫•t ng·ªù, ƒëi·ªán ·∫£nh (v√≠ d·ª•: Ab trong C major)</li>
    </ul>
</div>
<div class="mt-10">
    <h4 class="font-bold text-lg text-teal-600">Chuy·ªÉn Gi·ªçng (Modulation) V·ªõi H·ª£p √Çm Chung</h4>
    <p>ƒê·ªÉ chuy·ªÉn t·ª´ gi·ªçng n√†y sang gi·ªçng kh√°c m·ªôt c√°ch m∆∞·ª£t m√†, ta th∆∞·ªùng d√πng h·ª£p √¢m chung ("pivot chord").</p>
    <ul class="list-disc list-inside mt-2 space-y-1">
        <li>V√≠ d·ª•: G ‚Äì Am ‚Äì Bm ‚Äì <b>F#7 ‚Äì B7 ‚Äì Em</b> ‚Üí chuy·ªÉn m∆∞·ª£t t·ª´ G major sang E minor.</li>
        <li>Ho·∫∑c: C ‚Äì F ‚Äì G ‚Äì <b>G7 ‚Äì C</b> ‚Üí sau ƒë√≥ chuy·ªÉn sang A minor b·∫±ng E7 ‚Äì Am.</li>
    </ul>
</div>
</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let chordShapes = {};
        let selectedChord = null; // This will no longer be used for single diagram drawing
        let currentDiatonicChords = []; // Store current key's chords to redraw on instrument change

        const musicData = {
            notes: ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"],
            getNote: function(rootIndex, interval) {
                return this.notes[(rootIndex + interval) % 12];
            },
            getKeyData: function(keyName, mode) {
                const rootIndex = this.notes.indexOf(keyName);
                if (rootIndex === -1) return null;

                const majorScaleIntervals = [0, 2, 4, 5, 7, 9, 11];
                const minorScaleIntervals = [0, 2, 3, 5, 7, 8, 10];

                const intervals = mode === 'major' ? majorScaleIntervals : minorScaleIntervals;

                const chords = intervals.map((interval, i) => {
                    const note = this.getNote(rootIndex, interval);
                    let quality = '';
                    if (mode === 'major') {
                        if ([0, 3, 4].includes(i)) quality = '';
                        else if ([1, 2, 5].includes(i)) quality = 'm';
                        else quality = 'dim';
                    } else { // minor
                        if ([2, 5, 6].includes(i)) quality = '';
                        else if ([0, 3].includes(i)) quality = 'm';
                        else if (i === 1) quality = 'dim';
                        else if (i === 4) quality = 'm (or Major)';
                    }
                    return { note, quality, degree: i };
                });

                if (mode === 'minor') {
                    const harmonicV = { ...chords[4], quality: '', note: this.getNote(rootIndex, intervals[4]) };
                    chords[4] = harmonicV;
                }
                
                return chords;
            }
        };

        const progressionsData = {
            major: [
                { roman: "I ‚Äì IV ‚Äì V ‚Äì I", desc: "C∆° b·∫£n, d√¢n gian, pop nh·∫π. T·∫°o c·∫£m gi√°c ho√†n ch·ªânh, ·ªïn ƒë·ªãnh." },
                { roman: "I ‚Äì V ‚Äì vi ‚Äì IV", desc: "Ballad hi·ªán ƒë·∫°i, pop, rock. C·∫£m x√∫c s√¢u l·∫Øng, d·ªÖ nghe." },
                { roman: "vi ‚Äì IV ‚Äì I ‚Äì V", desc: "Nh·∫π nh√†ng, n·ªôi t√¢m, h∆°i bu·ªìn man m√°c. Ph√π h·ª£p c·∫£nh suy t∆∞." },
                { roman: "ii ‚Äì V ‚Äì I", desc: "V√≤ng jazz c·ªï ƒëi·ªÉn. Chuy·ªÉn ƒë·ªông m∆∞·ª£t m√†, sang tr·ªçng." },
                { roman: "I ‚Äì iii ‚Äì IV ‚Äì V", desc: "K·ªÉ chuy·ªán, phi√™u l∆∞u, c√≥ s·ª± ph√°t tri·ªÉn v√† bi·∫øn ƒë·ªïi." },
                { roman: "I ‚Äì IV ‚Äì ii ‚Äì V", desc: "Bi·∫øn th·ªÉ m∆∞·ª£t m√† h∆°n c·ªßa I-IV-V-I. Ph√π h·ª£p c·∫£nh b√¨nh y√™n, th∆∞ gi√£n." }
            ],
            minor: [
                { roman: "i ‚Äì VI ‚Äì VII ‚Äì i", desc: "M·∫°nh m·∫Ω, s·ª≠ thi. Ph√π h·ª£p rock, pop, c·∫£nh chi·∫øn ƒë·∫•u." },
                { roman: "i ‚Äì iv ‚Äì V ‚Äì i", desc: "Kinh ƒëi·ªÉn, k·ªãch t√≠nh. Ph√π h·ª£p blues, rock, c·∫£nh h·ªìi h·ªôp, gi·∫£i quy·∫øt xung ƒë·ªôt." },
                { roman: "i ‚Äì VI ‚Äì III ‚Äì VII", desc: "L√£ng m·∫°n, ho√†i ni·ªám, b√≠ ·∫©n. Ph√π h·ª£p c·∫£nh kh√°m ph√°, khu v·ª±c c·ªï k√≠nh." },
                { roman: "ii¬∞ ‚Äì V ‚Äì i", desc: "V√≤ng jazz trong gi·ªçng th·ª©. Tinh t·∫ø, ph√π h·ª£p c·∫£nh ƒë√™m, ƒë·ªëi tho·∫°i s√¢u s·∫Øc." },
                { roman: "i ‚Äì VII ‚Äì VI ‚Äì V", desc: "Ti·∫øn l√™n, h√πng tr√°ng, k·ªãch t√≠nh. Ph√π h·ª£p c·∫£nh h√†nh qu√¢n, chu·∫©n b·ªã chi·∫øn ƒë·∫•u." }
            ]
        };

        const gameScenariosData = [
            { title: "M·ªü ƒê·∫ßu / Khu An To√†n", icon: "üèûÔ∏è", emotion: "B√¨nh y√™n, ch√†o ƒë√≥n", progressions: ["I ‚Äì IV ‚Äì V ‚Äì I (Tr∆∞·ªüng)", "vi ‚Äì IV ‚Äì I ‚Äì V (Tr∆∞·ªüng, ch·∫≠m)"] },
            { title: "L√†ng M·∫°c / Th·ªã Tr·∫•n", icon: "üèòÔ∏è", emotion: "Th√¢n thi·ªán, nh·ªôn nh·ªãp", progressions: ["I ‚Äì vi ‚Äì IV ‚Äì V (Tr∆∞·ªüng)", "I ‚Äì IV ‚Äì ii ‚Äì V (Tr∆∞·ªüng)"] },
            { title: "Hang ƒê·ªông / H·∫ßm Ng·ª•c", icon: "ü¶á", emotion: "B√≠ ·∫©n, cƒÉng th·∫≥ng", progressions: ["i ‚Äì VI ‚Äì III ‚Äì VII (Th·ª©)", "i ‚Äì iv ‚Äì V ‚Äì i (Th·ª©)"] },
            { title: "R·ª´ng S√¢u / Kh√°m Ph√°", icon: "üå≤", emotion: "K·ª≥ b√≠, phi√™u l∆∞u", progressions: ["i ‚Äì VI ‚Äì VII ‚Äì i (Th·ª©)", "I ‚Äì iii ‚Äì IV ‚Äì V (Tr∆∞·ªüng)"] },
            { title: "Chi·∫øn ƒê·∫•u / Nguy Hi·ªÉm", icon: "‚öîÔ∏è", emotion: "K·ªãch t√≠nh, kh·∫©n tr∆∞∆°ng", progressions: ["i ‚Äì VII ‚Äì VI ‚Äì V (Th·ª©, nhanh)", "i ‚Äì iv ‚Äì V ‚Äì i (Th·ª©)"] },
            { title: "Chi·∫øn Th·∫Øng / Vinh Quang", icon: "üèÜ", emotion: "H√πng tr√°ng, h√¢n hoan", progressions: ["I ‚Äì V ‚Äì vi ‚Äì IV (Tr∆∞·ªüng)", "IV ‚Äì V ‚Äì I (Tr∆∞·ªüng)"] }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // --- Step 1: Initialize non-data-dependent UI elements ---
            const keySelector = document.getElementById('key-selector');
            const modeSelector = document.getElementById('mode-selector');
            const tabs = document.querySelectorAll('.tab-btn');
            const sections = document.querySelectorAll('.section');
            const chordViewRadios = document.querySelectorAll('input[name="chord-view"]');

            const allNotes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            allNotes.forEach(note => {
                const option = document.createElement('option');
                option.value = note;
                option.textContent = note.replace('#', '‚ôØ').replace('b', '‚ô≠');
                keySelector.appendChild(option);
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            // --- Step 2: Fetch data and initialize the rest of the app ---
            fetch('chord_shapes.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    chordShapes = data;

                    // --- Step 3: Now that data is loaded, set up event listeners and initial display ---
                    keySelector.addEventListener('change', updateDisplay);
                    modeSelector.addEventListener('change', updateDisplay);
                    
                    chordViewRadios.forEach(radio => {
                        radio.addEventListener('change', () => {
                            drawAllDiagrams(); // Redraw all diagrams on instrument change
                        });
                    });

                    // Initial display load
                    updateDisplay();
                    displayGameScenarios();
                })
                .catch(error => {
                    console.error('Error loading chord shapes:', error);
                    const keyDetailsContainer = document.getElementById('key-details');
                    if(keyDetailsContainer){
                        keyDetailsContainer.innerHTML = `<p class="col-span-full text-center text-red-600 bg-red-100 p-4 rounded-lg"><b>L·ªói:</b> Kh√¥ng th·ªÉ t·∫£i t·ªáp d·ªØ li·ªáu <code>chord_shapes.json</code>. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n t·ªáp v√† ƒë·∫£m b·∫£o t·ªáp c√≥ n·ªôi dung JSON h·ª£p l·ªá.</p>`;
                    }
                });
            
            // --- All function definitions remain below ---

            function updateDisplay() {
                const selectedKey = keySelector.value;
                const selectedMode = modeSelector.value;
                displayKey(selectedKey, selectedMode);
            }

            function displayKey(keyName, mode) {
                const diatonicChordsContainer = document.getElementById('diatonic-chords');
                const keyData = musicData.getKeyData(keyName, mode);
                const romanNumeralsMajor = ["I", "ii", "iii", "IV", "V", "vi", "vii¬∞"];
                const romanNumeralsMinor = ["i", "ii¬∞", "III", "iv", "V", "VI", "VII"];
                const numerals = mode === 'major' ? romanNumeralsMajor : romanNumeralsMinor;

                diatonicChordsContainer.innerHTML = '';
                currentDiatonicChords = []; // Reset the array for the new key

                if (!keyData) {
                    drawAllDiagrams(); // Clear diagrams if key data is invalid
                    return;
                }

                keyData.forEach(chord => {
                    let chordName = chord.note + chord.quality;
                    let displayName = `${chord.note.replace('#', '‚ôØ')}${chord.quality === 'dim' ? '¬∞' : (chord.quality === 'm (or Major)' ? '' : chord.quality)}`;
                    
                    if (chord.quality === 'm (or Major)') {
                        chordName = chord.note; 
                    }
                    const lookupName = chordName.replace('dim', '¬∞').replace('dim', 'Bdim'); // Fix for lookup

                    const card = document.createElement('div');
                    card.className = 'chord-card p-4 bg-white rounded-lg shadow-md text-center border-2 border-transparent transition-all';
                    
                    card.innerHTML = `
                        <div class="font-bold text-xl text-stone-800">${displayName}</div>
                        <div class="text-sm text-stone-500">${numerals[chord.degree]}</div>
                    `;
                    
                    diatonicChordsContainer.appendChild(card);
                    
                    // Store info needed for drawing
                    currentDiatonicChords.push({
                        lookupName: chordName.replace('dim', 'Bdim'), // Bdim is the key in JSON
                        displayName: displayName
                    });
                });
                
                drawAllDiagrams();
                displayProgressions(keyName, mode);
            }

            function displayProgressions(keyName, mode) {
                const progressionsContainer = document.getElementById('progressions');
                const progressions = progressionsData[mode];
                progressionsContainer.innerHTML = '';
                if (!progressions) return;

                progressions.forEach(prog => {
                    const progCard = document.createElement('div');
                    progCard.className = 'p-4 bg-stone-50 rounded-lg shadow';
                    progCard.innerHTML = `
                        <h4 class="font-semibold text-lg text-teal-600">${prog.roman}</h4>
                        <p class="text-stone-700">${prog.desc}</p>
                    `;
                    progressionsContainer.appendChild(progCard);
                });
            }

        });

        function displayGameScenarios() {
            const container = document.getElementById('game-scenarios');
            if (!container) return;
            container.innerHTML = '';
            gameScenariosData.forEach(scenario => {
                const card = document.createElement('div');
                card.className = 'p-6 bg-white rounded-xl shadow-md flex flex-col items-center text-center';
                card.innerHTML = `
                    <div class="text-5xl mb-3">${scenario.icon}</div>
                    <h4 class="font-bold text-xl text-teal-700 mb-2">${scenario.title}</h4>
                    <p class="text-stone-600 italic mb-3">"${scenario.emotion}"</p>
                    <div class="text-left">
                        <p class="font-semibold text-stone-800">V√≤ng h√≤a thanh g·ª£i √Ω:</p>
                        <ul class="list-disc list-inside text-stone-700">
                            ${scenario.progressions.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function drawAllDiagrams() {
            const diagramsContainer = document.getElementById('chord-diagrams-container');
            const instrument = document.querySelector('input[name="chord-view"]:checked').value;
            diagramsContainer.innerHTML = ''; // Clear previous diagrams

            if (!currentDiatonicChords || currentDiatonicChords.length === 0) return;

            currentDiatonicChords.forEach(chordInfo => {
                const lookupName = chordInfo.lookupName.replace('¬∞', 'dim');
                const shapeData = chordShapes[lookupName];
                let diagramCell = document.createElement('div');
                diagramCell.className = 'flex justify-center items-start h-full';

                if (!shapeData) {
                    diagramCell.innerHTML = `<div class="w-full text-center mt-2"><p class="text-xs text-stone-400">Ch∆∞a c√≥ d·ªØ li·ªáu</p></div>`;
                } else if (instrument === 'guitar' && shapeData.guitar) {
                    diagramCell.appendChild(drawGuitarChord(shapeData.guitar));
                } else if (instrument === 'piano' && shapeData.piano) {
                    diagramCell.appendChild(drawPianoChord(shapeData.piano));
                } else {
                    diagramCell.innerHTML = `<div class="w-full text-center mt-2"><p class="text-xs text-stone-400">Kh√¥ng c√≥ th·∫ø b·∫•m ${instrument}</p></div>`;
                }
                diagramsContainer.appendChild(diagramCell);
            });
        }


        function drawGuitarChord(positions, chordName) { // chordName is now optional
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const hasTitle = chordName && chordName !== "";
            const width = 120;
            const height = hasTitle ? 160 : 130;
            const startY = hasTitle ? 40 : 15;

            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.style.maxWidth = `${width}px`;

            const numStrings = 6;
            const numFrets = 5;
            const stringSpacing = (width - 40) / (numStrings - 1);
            const fretSpacing = (height - startY - 5) / numFrets;
            const startX = 20;

            if (hasTitle) {
                const title = document.createElementNS(svgNS, 'text');
                title.setAttribute('x', width / 2);
                title.setAttribute('y', 25);
                title.setAttribute('font-size', '20');
                title.setAttribute('font-weight', 'bold');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#44403c');
                title.textContent = chordName;
                svg.appendChild(title);
            }

            for (let i = 0; i <= numFrets; i++) {
                const y = startY + i * fretSpacing;
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", startX);
                line.setAttribute("y1", y);
                line.setAttribute("x2", startX + (numStrings - 1) * stringSpacing);
                line.setAttribute("y2", y);
                line.setAttribute("stroke", "#a8a29e");
                line.setAttribute("stroke-width", i === 0 ? 4 : 1);
                svg.appendChild(line);
            }

            for (let i = 0; i < numStrings; i++) {
                const x = startX + i * stringSpacing;
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", x);
                line.setAttribute("y1", startY);
                line.setAttribute("x2", x);
                line.setAttribute("y2", startY + numFrets * fretSpacing);
                line.setAttribute("stroke", "#a8a29e");
                line.setAttribute("stroke-width", 1);
                svg.appendChild(line);
            }
            
            // Note: Guitar string data is usually [E, A, D, G, B, e]. We draw from left to right.
            // The data seems to be [E, A, D, G, B, e], so string 0 is low E.
            positions.forEach((fret, stringIndex) => {
                const x = startX + stringIndex * stringSpacing; 
                if (fret === 'x' || fret === null) {
                    const text = document.createElementNS(svgNS, 'text');
                     text.setAttribute('x', x);
                     text.setAttribute('y', startY - 8);
                     text.setAttribute('font-size', '16');
                     text.setAttribute('text-anchor', 'middle');
                     text.setAttribute('fill', '#a8a29e');
                     text.textContent = 'x';
                     svg.appendChild(text);
                }
                else if (typeof fret === 'number' && fret > 0) {
                    const y = startY + fret * fretSpacing - (fretSpacing / 2);
                    const circle = document.createElementNS(svgNS, "circle");
                    circle.setAttribute("cx", x);
                    circle.setAttribute("cy", y);
                    circle.setAttribute("r", 7);
                    circle.setAttribute("fill", "#0d9488");
                    svg.appendChild(circle);
                } else if (fret === 0) {
                     const text = document.createElementNS(svgNS, 'text');
                     text.setAttribute('x', x);
                     text.setAttribute('y', startY - 8);
                     text.setAttribute('font-size', '16');
                     text.setAttribute('text-anchor', 'middle');
                     text.setAttribute('fill', '#44403c');
                     text.textContent = 'o';
                     svg.appendChild(text);
                }
            });

            return svg;
        }

        function drawPianoChord(notes, chordName) { // chordName is now optional
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const hasTitle = chordName && chordName !== "";
            const width = 220;
            const height = hasTitle ? 160 : 130;
            const startY = hasTitle ? 50 : 15;

            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.style.maxWidth = `${width}px`;

            if (hasTitle) {
                const title = document.createElementNS(svgNS, 'text');
                title.setAttribute('x', width / 2);
                title.setAttribute('y', 25);
                title.setAttribute('font-size', '20');
                title.setAttribute('font-weight', 'bold');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('fill', '#44403c');
                title.textContent = chordName;
                svg.appendChild(title);
            }

            const keyWidth = width / 14; // 14 white keys to span two octaves
            const keyHeight = height - startY - 5;
            const blackKeyWidth = keyWidth * 0.6;
            const blackKeyHeight = keyHeight * 0.6;
            
            const whiteKeyNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const notesInOctave = 12;
            const noteMap = { 'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11 };
            const pianoNotes = notes.map(n => n.toUpperCase().replace('‚ôØ','#').replace('‚ô≠','B')); // Simple mapping for flat

            const pressedKeys = new Set();
            pianoNotes.forEach(noteName => {
                const normalizedNote = noteName.endsWith('B') && noteName.length > 1 ? String.fromCharCode(noteName.charCodeAt(0)-1) + '#' : noteName;
                 if (noteMap[normalizedNote] !== undefined) {
                    pressedKeys.add(noteMap[normalizedNote]);
                } else if(noteMap[noteName] !== undefined){
                     pressedKeys.add(noteMap[noteName]);
                }
            });

            // Draw white keys
            for (let i = 0; i < 14; i++) { // Draw 14 white keys for two octaves
                const key = document.createElementNS(svgNS, "rect");
                const xPos = i * keyWidth;
                key.setAttribute("x", xPos);
                key.setAttribute("y", startY);
                key.setAttribute("width", keyWidth);
                key.setAttribute("height", keyHeight);
                key.setAttribute("stroke", "#44403c");
                
                const noteIndex = noteMap[whiteKeyNotes[i % 7]];
                const isPressed = pressedKeys.has(noteIndex);
                key.setAttribute("fill", isPressed ? "#0d9488" : "white");
                svg.appendChild(key);
            }
            
            // Draw black keys
            const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0]; // C#, D#, F#, G#, A#
            let whiteKeyIndex = 0;
            for(let i=0; i < 13; i++){ // Draw 13 black keys
                if(whiteKeyNotes[i % 7] === 'E' || whiteKeyNotes[i % 7] === 'B') continue;

                const key = document.createElementNS(svgNS, "rect");
                const xPos = (i + 1) * keyWidth - (blackKeyWidth / 2);
                key.setAttribute("x", xPos);
                key.setAttribute("y", startY);
                key.setAttribute("width", blackKeyWidth);
                key.setAttribute("height", blackKeyHeight);
                key.setAttribute("rx", "2");
                key.setAttribute("ry", "2");
                key.setAttribute("stroke", "black");
                
                const noteIndex = noteMap[whiteKeyNotes[i % 7]] + 1;
                const isPressed = pressedKeys.has(noteIndex);
                key.setAttribute("fill", isPressed ? "#0d9488" : "black");

                svg.appendChild(key);
            }
            return svg;
        }

    </script>
    <div class="text-center mt-4 text-sm text-stone-500">
        <p>DuongPham</p></div>
        <div></div>

</body>
</html>
